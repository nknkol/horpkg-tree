name: Build Tree Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build for ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [arm64-v8a, x86_64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup HarmonyOS SDK
        run: |
          # å®šä¹‰SDK URLå’Œæ–‡ä»¶å
          SDK_URL="https://github.com/SwimmingTiger/third_party_llvm-project/releases/download/15.0.4-ohos-cli-5.1.0-2/ohos-command-line-tools-5.1.0-2-for-debian-12-arm64.tar.xz"
          SDK_ARCHIVE="ohos-command-line-tools.tar.xz"
          TOOL_DIR="$HOME/command-line-tools"

          echo "ðŸ“¥ Downloading HarmonyOS command line tools for ARM64..."
          wget -q --show-progress -O "${SDK_ARCHIVE}" "${SDK_URL}"

          echo "ðŸ“¦ Extracting tools..."
          mkdir -p "${TOOL_DIR}"
          tar -vxf "${SDK_ARCHIVE}" -C "${TOOL_DIR}" --strip-components=1
          rm "${SDK_ARCHIVE}"

          echo "âœ… SDK setup complete."
          echo "OHOS_SDK_HOME=${TOOL_DIR}/sdk/default/openharmony" >> $GITHUB_ENV
        # ä»…åœ¨ç¼–è¯‘ arm64-v8a æ—¶æ‰§è¡Œæ­¤æ­¥éª¤
        if: matrix.arch == 'arm64-v8a'

      # ä¸º x86_64 ä¿ç•™å¤‡ç”¨çš„ SDK ä¸‹è½½æ–¹å¼ (å¦‚æžœéœ€è¦)
      - name: Setup HarmonyOS SDK for x86_64
        run: |
          echo "â¬ Downloading SDK for x86_64... (using a different URL if necessary)"
          # æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ä¸€ä¸ªé€‚ç”¨äºŽ x86_64 GitHub Runner çš„ SDK ä¸‹è½½é“¾æŽ¥
          # æš‚æ—¶ä½¿ç”¨ä¸Ž arm64 ç›¸åŒçš„é“¾æŽ¥ä½œä¸ºå ä½ç¬¦ï¼Œå› ä¸ºå®ƒä¹ŸåŒ…å« x86_64 å·¥å…·é“¾
          SDK_URL="https://github.com/SwimmingTiger/third_party_llvm-project/releases/download/15.0.4-ohos-cli-5.1.0-2/ohos-command-line-tools-5.1.0-2-for-debian-12-arm64.tar.xz"
          SDK_ARCHIVE="ohos-command-line-tools.tar.xz"
          TOOL_DIR="$HOME/command-line-tools"
          wget -q --show-progress -O "${SDK_ARCHIVE}" "${SDK_URL}"
          mkdir -p "${TOOL_DIR}"
          tar -vxf "${SDK_ARCHIVE}" -C "${TOOL_DIR}" --strip-components=1
          rm "${SDK_ARCHIVE}"
          echo "OHOS_SDK_HOME=${TOOL_DIR}/sdk/default/openharmony" >> $GITHUB_ENV
        if: matrix.arch == 'x86_64'

      - name: Build Package
        run: |
          chmod +x build.sh
          ./build.sh ${{ matrix.arch }}

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tree-${{ matrix.arch }}
          path: |
            tree-*.hnp
            tree-*.hnp.sha256

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            tree-arm64-v8a/tree-*.hnp
            tree-arm64-v8a/tree-*.hnp.sha256
            tree-x86_64/tree-*.hnp
            tree-x86_64/tree-*.hnp.sha256